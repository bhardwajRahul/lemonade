<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setting up NPU software stack - Lemonade Server</title>
  <link rel="icon" href="./assets/favicon.ico">
  <link rel="stylesheet" href="assets/website-styles.css">
</head>
<body>
  <div class="navbar-placeholder"></div>

  <main class="main">
    <div class="hero-section">
      <div class="main-heading">
        Setting up NPU software stack
      </div>
    </div>

    <!-- NPU Setup Content -->
    <div class="install-content">
      <div class="install-section">
        <h2>Background</h2>
        <p>
          Your system has an AMD NPU (Neural Processing Unit), but the software stack required
          to use it is not properly configured. The NPU requires specific firmware, kernel version,
          driver, and runtime software to function.
        </p>
        <p>
          <strong>Requirements:</strong>
        </p>
        <ul>
          <li><strong>NPU Firmware:</strong> Version 1.1.0.0 or later</li>
          <li><strong>Kernel:</strong> Version 7.0 or later (includes amdxdna driver)</li>
          <li><strong>Runtime:</strong> FLM (FastFlowLM) installed</li>
          <li><strong>System limits:</strong> Sufficient memlock limits (handled by Lemonade's systemd service)</li>
        </ul>
      </div>

      <div class="install-section">
        <h2>Setup</h2>

        <!-- Install FLM -->
        <div class="option-box option-primary">
          <div class="option-header">
            <span class="option-label">Step 1: Install FLM</span>
          </div>
          <h3>Install FastFlowLM</h3>
          <p>
            FLM (FastFlowLM) is the inference engine for running models on the NPU. It includes a validation tool that checks your system for compatibility.
          </p>
          <p>
            Visit the <a href="https://github.com/FastFlowLM/FastFlowLM/releases" target="_blank">FLM Releases page</a>
            and download the latest Linux binary for your system.
          </p>
        </div>

        <!-- Run flm validate -->
        <div class="option-box option-primary">
          <div class="option-header">
            <span class="option-label">Step 2: Run Validation</span>
          </div>
          <h3>Verify your NPU stack</h3>
          <p>
            After installing FLM, run the following command to check if your system is ready for NPU inference:
          </p>
          <div class="code-block">
            <code>flm validate</code>
          </div>
          <p>
            This tool will check your NPU firmware, kernel version, and system limits. If any checks fail, follow the guidance in the section below.
          </p>
        </div>
      </div>

      <div class="install-section">
        <h2>Common flm validate issues</h2>

        <h3>1. Outdated NPU Firmware</h3>
        <p>If <code>flm validate</code> reports a firmware issue, ensure you have version <strong>1.1.0.0 or later</strong>.</p>
        <p>You can check your version manually with:</p>
        <div class="code-block">
          <code>cat /sys/bus/pci/drivers/amdxdna/*/fw_version</code>
        </div>
        <p>If the firmware is older than 1.1.0.0, you'll need to update it through your Linux distribution (typically by updating the <code>linux-firmware</code> package).</p>

        <h3>2. Outdated Kernel</h3>
        <p>The NPU requires kernel version <strong>7.0 or later</strong> (which includes the <code>amdxdna</code> driver).</p>
        <p>Check your kernel version:</p>
        <div class="code-block">
          <code>uname -r</code>
        </div>
        <p>If your kernel is older than 7.0, you must upgrade to a newer version. Release candidates (e.g., 7.0-rc) are not supported.</p>

        <h3>3. Memlock limit too low</h3>
        <p>NPU workloads require the ability to lock memory. If you see an error like <strong>"Memlock limit is too low (8MB)"</strong>, you need to increase it.</p>
        <p><strong>Recommended:</strong> Use Lemonade's systemd service, which automatically sets <code>LimitMEMLOCK=infinity</code>.</p>
        <p>To fix this manually for your user account, edit <code>/etc/security/limits.conf</code>:</p>
        <div class="code-block">
          <code>sudo nano /etc/security/limits.conf</code>
        </div>
        <p>Add these lines at the end:</p>
        <div class="code-block">
          <code>*    soft    memlock    unlimited
*    hard    memlock    unlimited</code>
        </div>
        <p>Then <strong>log out and log back in</strong> for changes to take effect.</p>
      </div>

      <div class="install-section">
        <h2>Additional Resources</h2>
        <p>
          For detailed NPU setup instructions and troubleshooting:
        </p>
        <ul>
          <li><a href="https://github.com/FastFlowLM/FastFlowLM" target="_blank">FastFlowLM GitHub Repository</a></li>
        </ul>
      </div>

      <div class="install-section">
        <h2>Need Help?</h2>
        <p>
          If you continue to experience issues after setting up the NPU stack:
        </p>
        <ul>
          <li>Check the <a href="https://github.com/lemonade-sdk/lemonade/issues">GitHub Issues</a> page</li>
          <li>Contact us on <a href="https://discord.gg/lemonade-server">Discord</a></li>
        </ul>
      </div>
    </div>
  </main>

  <!-- Footer will be inserted here by footer.js -->
  <div class="footer-placeholder"></div>

  <script src="assets/navbar.js"></script>
  <script src="assets/footer.js"></script>
  <script>
    // Initialize footer when page loads
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof initializeNavbar === 'function') {
        initializeNavbar('./');
      }
      if (typeof initializeFooter === 'function') {
        initializeFooter('./');
      }
    });
  </script>

  <style>
    .install-content {
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .install-section {
      margin-bottom: 3rem;
    }

    .install-section h2 {
      color: #2c3e50;
      border-bottom: 2px solid #e74c3c;
      padding-bottom: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .install-section ul {
      margin-left: 2rem;
      line-height: 1.8;
    }

    .install-section p {
      line-height: 1.6;
      color: #555;
      margin-bottom: 1rem;
    }

    .code-block {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      font-family: 'Courier New', monospace;
      overflow-x: auto;
    }

    .code-block code {
      color: #ecf0f1;
      background: none;
      padding: 0;
    }

    .option-box {
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }

    .option-primary {
      background: linear-gradient(135deg, #fef5e7, #fdebd0);
      border: 2px solid #f39c12;
    }

    .option-secondary {
      background: #f8f9fa;
      border: 2px solid #bdc3c7;
    }

    .option-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .option-label {
      font-weight: bold;
      font-size: 1.1rem;
      color: #2c3e50;
    }

    .option-tag {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .option-tag.recommended {
      background: #27ae60;
      color: white;
    }

    .option-box h3 {
      margin: 0 0 0.75rem 0;
      color: #2c3e50;
    }

    .option-note {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #666;
      font-style: italic;
    }

    .step-container {
      margin: 2rem 0;
    }

    .step {
      display: flex;
      align-items: flex-start;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #e74c3c;
    }

    .step-number {
      background: #e74c3c;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      margin-right: 1.5rem;
      flex-shrink: 0;
    }

    .step-content h3 {
      margin: 0 0 0.5rem 0;
      color: #2c3e50;
    }

    .step-content p {
      margin: 0 0 1rem 0;
    }

    .step-content ul {
      margin: 0.5rem 0 0.5rem 2rem;
    }

    @media (max-width: 768px) {
      .install-content {
        padding: 0 1rem;
      }

      .step {
        flex-direction: column;
        text-align: center;
      }

      .step-number {
        margin: 0 auto 1rem auto;
      }
    }
  </style>
</body>
</html>
