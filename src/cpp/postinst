#!/bin/bash

# Create the lemonade user and group if they don't exist
if ! getent group lemonade > /dev/null; then
    groupadd lemonade
fi

if ! getent passwd lemonade > /dev/null; then
    useradd -m -r -g lemonade -d /opt/var/lib/lemonade -s /usr/sbin/nologin lemonade
fi

# Add lemonade user to render group for GPU access
usermod -a -G render lemonade

# Add lemonade user to systemd-journal group for journal access
# This allows the server to read logs from journald for the web API
if getent group systemd-journal > /dev/null; then
    usermod -a -G systemd-journal lemonade
fi

# Set up the service
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
        if deb-systemd-helper --quiet was-enabled 'lemonade-server.service'; then
                deb-systemd-helper enable 'lemonade-server.service' >/dev/null || true
        else
                deb-systemd-helper update-state 'lemonade-server.service' >/dev/null || true
        fi
        if [ -d /run/systemd/system ]; then
                systemctl --system daemon-reload >/dev/null || true
                if [ -n "$2" ]; then
                        _dh_action=restart
                else
                        _dh_action=start
                fi
                deb-systemd-invoke $_dh_action 'lemonade-server.service' >/dev/null || true
        fi
fi

exit 0
